<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mad√®re ‚Äî Carnet de voyage</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0f172a" />

  <style>
    :root { --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#22c55e; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
    .app { display:grid; grid-template-rows:auto 1fr; height:100dvh; }
    header { display:flex; gap:12px; align-items:center; padding:10px 12px; background:var(--panel); border-bottom:1px solid rgba(255,255,255,.08); }
    header h1 { font-size:16px; margin:0; font-weight:650; }
    header .spacer { flex:1; }
    select, button, input, textarea {
      background: rgba(255,255,255,.06); color:var(--text);
      border:1px solid rgba(255,255,255,.10); border-radius:10px;
      padding:8px 10px; font-size:14px;
    }
    button { cursor:pointer; }
    button.primary { border-color: rgba(34,197,94,.5); }
    .main { display:grid; grid-template-columns: 320px 1fr; height:100%; }
    @media (max-width: 900px) {
  .main { grid-template-columns: 1fr; }
  #map { height: 100dvh; }               /* üëà carte plein √©cran */
    .sidebar {
    position: fixed;
    left: 0; right: 0; bottom: 0;
    z-index: 9000;

    height: 55dvh;
    max-height: 55dvh;

    display: flex;
    flex-direction: column;

    padding: 12px;
    box-sizing: border-box;

    overflow: hidden;           /* üëà important : on emp√™che la sidebar de scroller */
    min-height: 0;              /* üëà cl√© pour permettre au child scroll */

    transform: translateY(100%);
    transition: transform .25s ease;

    background: rgba(11,18,32,.98);
    border-top: 1px solid rgba(255,255,255,.10);
  }

  .sidebar.open { transform: translateY(0); }
}
  .mobile-toggle {
    position: fixed;
    left: 14px;
    bottom: 14px;
    z-index: 9500;
    border-radius: 999px;
    padding: 12px 14px;
    background: rgba(255,255,255,.08);
    border: 1px solid rgba(255,255,255,.12);
    backdrop-filter: blur(8px);
    font-weight: 700;
  }


}
    .popup-title { font-weight:700; margin-bottom:4px; }
    .popup-meta { font-size:12px; color:#cbd5e1; margin-bottom:6px; }
    .popup-note { font-size:12px; color:#e5e7eb; white-space:pre-wrap; }
    .footer { font-size:11px; color:var(--muted); margin-top:8px; }
    
    
      .fab {
    position: fixed;
    right: 14px;
    bottom: 14px;
    z-index: 9999;
    border-radius: 999px;
    padding: 12px 14px;
    background: rgba(34,197,94,.18);
    border: 1px solid rgba(34,197,94,.45);
    backdrop-filter: blur(8px);
    font-weight: 700;
  }
      /* Conteneur de la liste */
.list {
  flex: 1;                        /* prend tout l‚Äôespace restant */
  min-height: 0;                  /* üëà cl√© : autorise le scroll dans un child flex */
  overflow-y: auto;               /* scroll vertical */
  -webkit-overflow-scrolling: touch;
}

  .modal-backdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,.55);
    z-index: 10000;
    display: none;
    align-items: flex-end;
    justify-content: center;
  }
  .modal {
    width: min(720px, 100%);
    background: rgba(15,23,42,.98);
    border: 1px solid rgba(255,255,255,.10);
    border-bottom: none;
    border-radius: 18px 18px 0 0;
    padding: 12px;
    max-height: 85dvh;
    overflow: auto;
  }
  .modal h3 { margin: 4px 0 10px 0; font-size: 15px; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  @media (max-width: 520px){ .row{ grid-template-columns:1fr; } }
  .modal label { display:block; font-size:12px; color: var(--muted); margin-top:10px; }
  .modal input, .modal textarea, .modal select {
    width: 100%;
    box-sizing: border-box;
    margin-top: 6px;
  }
  .modal textarea { min-height: 90px; resize: vertical; }
  .actions { display:flex; gap:10px; margin-top:12px; }
  .actions button { flex: 1; }
  .danger { border-color: rgba(239,68,68,.5); background: rgba(239,68,68,.12); }
  .hint { font-size: 12px; color: var(--muted); margin-top: 8px; line-height:1.3; }
    
    
    
    .thumb {
  position: relative;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
}
.thumb img {
  width: 100%;
  height: 92px;
  object-fit: cover;
  display:block;
}
.thumb button {
  position:absolute;
  right:6px;
  top:6px;
  padding:4px 8px;
  border-radius:999px;
  font-size:12px;
}
    
  
    
  </style>
</head>

<body>
  
  <div class="app">
    <header>
      <h1>Mad√®re ‚Äî Carnet de voyage</h1>
      <span class="spacer"></span>

      <!-- √âtape 1 : gestion simple d'utilisateur -->
      <label class="muted">Utilisateur</label>
      <select id="userSelect">
        <option value="Salima">Salima</option>
        <option value="R√©my" selected>R√©my</option>
      </select>

      <button class="primary" id="btnLocate" title="Centrer sur ma position">üìç Ma position</button>
    </header>

    <div class="main">
      <aside class="sidebar">
        <div class="card">
          <h2>Points planifi√©s</h2>
          <div class="muted">
            Clique sur un point dans la liste ou sur la carte pour afficher la fiche (infos, note, commentaire).
            <br>√âtape 2 : on ajoutera l‚Äôajout/suppression/√©dition + photos.
          </div>
          <div class="footer" id="storageInfo"></div>
        </div>

        <div class="card">
          <h2>Filtre</h2>
          <div class="muted">Recherche par nom / tag</div>
          <input id="search" placeholder="Ex : levada, pico, funchal..." style="width:100%; margin-top:8px;" />
        </div>

        <div class="list" id="poiList"></div>
      </aside>

      <div id="map"></div>
    </div>
  </div>

<button class="mobile-toggle" id="btnToggleList">üìã Liste</button> 
<button class="fab" id="btnAdd">‚ûï Ajouter</button>

<div class="modal-backdrop" id="backdrop">
  <div class="modal">
    <h3 id="modalTitle">Ajouter un point</h3>

    <div class="row">
      <div>
        <label>Nom</label>
        <input id="f_name" placeholder="Ex : Levada do Caldeir√£o Verde" />
      </div>
      <div>
        <label>Cat√©gorie</label>
        <select id="f_type">
          <option>Rando</option>
          <option>Ville</option>
          <option>Spot</option>
          <option>Restaurant</option>
          <option>Point de vue</option>
          <option>Plage</option>
          <option>Autre</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Liste</label>
        <select id="f_bucket">
          <option value="visited">Visit√©s</option>
          <option value="planned">Planifi√©s</option>
        </select>
      </div>
      <div>
        <label>Note (0‚Äì5)</label>
        <input id="f_note" type="number" min="0" max="5" step="1" value="0" />
      </div>
    </div>

    <label>Tags (s√©par√©s par des virgules)</label>
    <input id="f_tags" placeholder="ex : levada, cascade, coucher de soleil" />

    <label>Commentaire</label>
    <textarea id="f_comment" placeholder="Ce que tu veux retenir, tips, horaires, m√©t√©o..."></textarea>

    <div class="hint" id="coordHint">Coordonn√©es : ‚Äî</div>

    <div class="actions">
      <button id="btnCancel">Annuler</button>
      <button class="primary" id="btnSave">Enregistrer</button>
    </div>
    <div class="actions" id="editActions" style="display:none;">
      <button class="danger" id="btnDelete">üóëÔ∏è Supprimer</button>
    </div>
    
    <label>Photos (plusieurs possibles)</label>
<input id="f_photos" type="file" accept="image/*" multiple />

<div class="hint">Astuce : sur Android, tu peux choisir ‚ÄúCam√©ra‚Äù ou ‚ÄúGalerie‚Äù.</div>

<div id="photoGrid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin-top:10px;"></div>
    
  </div>
</div>




<script>


  // -----------------------------
  // Donn√©es & stockage local
  // -----------------------------
  const DEFAULT_PLANNED_POIS = [
    {
      id: "pico-ruivo",
      name: "Pico Ruivo",
      type: "Rando",
      tags: ["pico", "rando", "lever-soleil"],
      lat: 32.7606, lng: -16.9360,
      info: "Point culminant de Mad√®re. Id√©al t√¥t le matin.",
      noteByUser: { "Salima": 0, "R√©my": 0 },
      commentByUser: { "Salima": "", "R√©my": "" }
    },
    {
      id: "funchal-old-town",
      name: "Funchal ‚Äî Vieille ville",
      type: "Ville",
      tags: ["funchal", "resto", "balade"],
      lat: 32.6496, lng: -16.9087,
      info: "Balade + march√© + ruelles. Bien en fin de journ√©e.",
      noteByUser: { "Salima": 0, "R√©my": 0 },
      commentByUser: { "Salima": "", "R√©my": "" }
    }
  ];

  const STORAGE = {
    planned: "madeira_planned_pois_v2",
    visited: "madeira_visited_pois_v2",
    user: "madeira_user_v1"
  };
  
  
  // -----------------------------
// IndexedDB (photos)
// -----------------------------
const PHOTO_DB = "madeira_photo_db_v1";
const PHOTO_STORE = "photos"; // { id, pointId, blob, createdAt, name, type }

function idbOpen() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(PHOTO_DB, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      const store = db.createObjectStore(PHOTO_STORE, { keyPath: "id" });
      store.createIndex("byPoint", "pointId", { unique: false });
      store.createIndex("byCreatedAt", "createdAt", { unique: false });
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function idbTx(mode, fn) {
  const db = await idbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(PHOTO_STORE, mode);
    const store = tx.objectStore(PHOTO_STORE);
    const res = fn(store);
    tx.oncomplete = () => { db.close(); resolve(res); };
    tx.onerror = () => { db.close(); reject(tx.error); };
  });
}


async function addPhotosForPoint(pointId, files) {
  // compresser + stocker
  for (const f of files) {
    const c = await compressImageToWebP(f); // important pour Android
    const rec = {
      id: uid("ph"),
      pointId,
      blob: c,
      createdAt: Date.now(),
      name: c.name,
      type: c.type
    };
    await idbTx("readwrite", (store) => store.put(rec));
  }
}

async function getPhotosForPoint(pointId) {
  const db = await idbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(PHOTO_STORE, "readonly");
    const store = tx.objectStore(PHOTO_STORE);
    const idx = store.index("byPoint");
    const req = idx.getAll(pointId);
    req.onsuccess = () => {
      const arr = req.result || [];
      arr.sort((a,b) => a.createdAt - b.createdAt);
      db.close();
      resolve(arr);
    };
    req.onerror = () => { db.close(); reject(req.error); };
  });
}

async function deletePhoto(photoId) {
  await idbTx("readwrite", (store) => store.delete(photoId));
}




function uid(prefix="ph") {
  return prefix + "-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2,8);
}
  
  async function compressImageToWebP(file, maxW = 1600, quality = 0.82) {
  // Si le navigateur ne supporte pas, on renvoie le fichier tel quel
  if (!("createImageBitmap" in window)) return file;

  const bmp = await createImageBitmap(file);
  const ratio = Math.min(1, maxW / bmp.width);
  const w = Math.round(bmp.width * ratio);
  const h = Math.round(bmp.height * ratio);

  const canvas = document.createElement("canvas");
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(bmp, 0, 0, w, h);

  const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/webp", quality));
  if (!blob) return file;

  return new File([blob], file.name.replace(/\.\w+$/, ".webp"), { type: "image/webp" });
}
  

  function safeParse(raw, fallback) { try { return JSON.parse(raw); } catch { return fallback; } }

  function loadBucket(bucket) {
    const raw = localStorage.getItem(STORAGE[bucket]);
    if (!raw) return bucket === "planned" ? DEFAULT_PLANNED_POIS : [];
    return safeParse(raw, bucket === "planned" ? DEFAULT_PLANNED_POIS : []);
  }
  function saveBucket(bucket, arr) {
    localStorage.setItem(STORAGE[bucket], JSON.stringify(arr));
  }

  function loadUser() { return localStorage.getItem(STORAGE.user) || "R√©my"; }
  function saveUser(u) { localStorage.setItem(STORAGE.user, u); }

  let currentUser = loadUser();
  let planned = loadBucket("planned");
  let visited = loadBucket("visited");

  // -----------------------------
  // UI : user select
  // -----------------------------
  const userSelect = document.getElementById("userSelect");
  userSelect.value = currentUser;
  userSelect.addEventListener("change", () => {
    currentUser = userSelect.value;
    saveUser(currentUser);
    renderAll();
  });

  // -----------------------------
  // Map init
  // -----------------------------
  const map = L.map("map", { zoomControl: true }).setView([32.7600, -16.9500], 10);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const markersLayer = L.layerGroup().addTo(map);

  // -----------------------------
  // Helpers
  // -----------------------------
  const poiList = document.getElementById("poiList");
  const search = document.getElementById("search");

  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function markerLabel(p) {
    const u = currentUser;
    const note = (p.noteByUser?.[u] || 0);
    return note > 0 ? `‚≠ê ${note}/5` : "‚Äî";
  }

  function popupHtml(p, bucket) {
    const u = currentUser;
    const note = (p.noteByUser?.[u] || 0);
    const com = (p.commentByUser?.[u] || "");
    const tags = (p.tags || []).join(", ");
    return `
      <div class="popup-title">${escapeHtml(p.name)}</div>
      <div class="popup-meta">${escapeHtml(p.type)} ¬∑ ${markerLabel(p)} ¬∑ <b>${bucket === "planned" ? "Planifi√©" : "Visit√©"}</b></div>
      <div class="popup-note"><b>Info :</b> ${escapeHtml(p.info || "") || "‚Äî"}</div>
      <div class="popup-note" style="margin-top:6px;"><b>Tags :</b> ${escapeHtml(tags) || "‚Äî"}</div>
      <div class="popup-note" style="margin-top:6px;"><b>Ton commentaire (${escapeHtml(u)}) :</b>\n${escapeHtml(com || "‚Äî")}</div>
      <div class="popup-note" style="margin-top:8px; color:#cbd5e1;">
        Astuce: touche le point pour ouvrir sa fiche, puis utilise ‚ÄúAjouter‚Äù pour cr√©er un nouveau point.
      </div>
    `;
  }

  function matches(p, q) {
    if (!q) return true;
    q = q.toLowerCase().trim();
    const hay = [p.name, p.type, ...(p.tags||[]), p.info||""].join(" ").toLowerCase();
    return hay.includes(q);
  }

  function allPois() {
    return [
      ...planned.map(p => ({ ...p, __bucket: "planned" })),
      ...visited.map(p => ({ ...p, __bucket: "visited" }))
    ];
  }

  // -----------------------------
  // Render markers + list
  // -----------------------------
  function rebuildMarkers(filteredAll) {
    markersLayer.clearLayers();

    filteredAll.forEach(p => {
      const marker = L.marker([p.lat, p.lng], { title: p.name });

      marker.bindPopup(popupHtml(p, p.__bucket), { maxWidth: 260 });

      // Tap marker => open edit modal (super pratique sur mobile)
      marker.on("dblclick", (e) => {
        e.originalEvent?.preventDefault?.();
        openEditModal(p.__bucket, p.id);
      });

      marker.on("contextmenu", () => openEditModal(p.__bucket, p.id)); // long press on some devices

      marker.on("click", () => {
        marker.setPopupContent(popupHtml(p, p.__bucket));
      });

      marker.addTo(markersLayer);
    });
  }
  
  const btnToggleList = document.getElementById("btnToggleList");
const sidebar = document.querySelector(".sidebar");

function isMobile() { return window.matchMedia("(max-width: 900px)").matches; }

btnToggleList?.addEventListener("click", () => {
  if (!isMobile()) return;
  sidebar.classList.toggle("open");
});


  function renderList(filteredAll) {
    poiList.innerHTML = "";

    filteredAll.forEach(p => {
      const div = document.createElement("div");
      div.className = "item";
      const bucketLabel = p.__bucket === "planned" ? "Planifi√©" : "Visit√©";
      div.innerHTML = `
        <div class="top">
          <div>
            <div style="font-weight:700;">${escapeHtml(p.name)}</div>
            <div class="muted">${escapeHtml(p.type)} ¬∑ <span class="pill">${markerLabel(p)}</span> ¬∑ <span class="pill">${bucketLabel}</span></div>
          </div>
          <div class="pill">${escapeHtml((p.tags||[]).slice(0,2).join(" ¬∑ ") || "‚Äî")}</div>
        </div>
        <button data-id="${p.id}" data-bucket="${p.__bucket}">Voir / √âditer</button>
      `;

      div.querySelector("button").addEventListener("click", () => {
        map.setView([p.lat, p.lng], 14, { animate: true });
        openEditModal(p.__bucket, p.id);
      });

      poiList.appendChild(div);
    });

    document.getElementById("storageInfo").textContent =
      `Local: ${planned.length} planifi√©s ¬∑ ${visited.length} visit√©s (utilisateur: ${currentUser}).`;
  }

  function renderAll() {
    const q = search.value || "";
    const filteredAll = allPois().filter(p => matches(p, q));
    rebuildMarkers(filteredAll);
    renderList(filteredAll);
  }

  search.addEventListener("input", renderAll);

  // -----------------------------
  // Geoloc
  // -----------------------------
  document.getElementById("btnLocate").addEventListener("click", () => {
    if (!navigator.geolocation) return alert("G√©olocalisation non disponible.");
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 15, { animate: true });
        L.circleMarker([latitude, longitude], { radius: 8 }).addTo(map)
          .bindPopup("üìç Vous √™tes ici").openPopup();
      },
      (err) => alert("Impossible d‚Äôobtenir la position : " + err.message),
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
    );
  });

  // -----------------------------
  // Modal: add/edit
  // -----------------------------
  const backdrop = document.getElementById("backdrop");
  const modalTitle = document.getElementById("modalTitle");
  const coordHint = document.getElementById("coordHint");

  const f_name = document.getElementById("f_name");
  const f_type = document.getElementById("f_type");
  const f_bucket = document.getElementById("f_bucket");
  const f_note = document.getElementById("f_note");
  const f_tags = document.getElementById("f_tags");
  const f_comment = document.getElementById("f_comment");
  const f_photos = document.getElementById("f_photos");
const photoGrid = document.getElementById("photoGrid");

  const btnAdd = document.getElementById("btnAdd");
  const btnCancel = document.getElementById("btnCancel");
  const btnSave = document.getElementById("btnSave");
  const btnDelete = document.getElementById("btnDelete");
  const editActions = document.getElementById("editActions");

  let modalMode = "add"; // add | edit
  let modalLatLng = null; // {lat,lng}
  let editing = { bucket: null, id: null };

  function openBackdrop() { backdrop.style.display = "flex"; }
  function closeBackdrop() { backdrop.style.display = "none"; }

  backdrop.addEventListener("click", (e) => {
    if (e.target === backdrop) closeBackdrop();
  });
  btnCancel.addEventListener("click", closeBackdrop);

  function resetForm() {
    f_name.value = "";
    f_type.value = "Rando";
    f_bucket.value = "visited";
    f_note.value = "0";
    f_tags.value = "";
    f_comment.value = "";
    coordHint.textContent = "Coordonn√©es : ‚Äî";
  }

  function getBucketArray(bucket) {
    return bucket === "planned" ? planned : visited;
  }
  function setBucketArray(bucket, arr) {
    if (bucket === "planned") planned = arr;
    else visited = arr;
    saveBucket(bucket, arr);
  }

  function findPoi(bucket, id) {
    return getBucketArray(bucket).find(p => p.id === id) || null;
  }

  function openAddModal(latlng) {
    modalMode = "add";
    modalLatLng = latlng;
    editing = { bucket: null, id: null };

    resetForm();
    modalTitle.textContent = "Ajouter un point";
    editActions.style.display = "none";

    if (latlng) {
      coordHint.textContent = `Coordonn√©es : ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
    }
    openBackdrop();
  }

  function openEditModal(bucket, id) {
    const p = findPoi(bucket, id);
    if (!p) return;

    modalMode = "edit";
    modalLatLng = { lat: p.lat, lng: p.lng };
    editing = { bucket, id };

    resetForm();
    modalTitle.textContent = "√âditer un point";
    editActions.style.display = "flex";

    f_name.value = p.name || "";
    f_type.value = p.type || "Autre";
    f_bucket.value = bucket; // on permet de changer de bucket
    f_note.value = String(p.noteByUser?.[currentUser] || 0);
    f_tags.value = (p.tags || []).join(", ");
    f_comment.value = p.commentByUser?.[currentUser] || "";
    coordHint.textContent = `Coordonn√©es : ${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;

    openBackdrop();
    currentPointIdForPhotos = id;
renderPhotoGrid(id);
  }

  function slugId(name) {
    return (name || "point")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)/g, "")
      + "-" + Date.now().toString(36);
  }

  btnAdd.addEventListener("click", () => {
    // choix rapide: position GPS par d√©faut, sinon tap sur carte
    if (!navigator.geolocation) {
      alert("G√©olocalisation non disponible. Touche la carte pour choisir un emplacement.");
      openAddModal(null);
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => openAddModal({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
      () => {
        alert("Impossible d‚Äôobtenir la position. Touche la carte pour choisir un emplacement.");
        openAddModal(null);
      },
      { enableHighAccuracy: true, timeout: 9000, maximumAge: 30000 }
    );
  });

  // Tap sur la carte => add at tap location (super pratique)
  map.on("click", (e) => {
    // si la modal est d√©j√† ouverte, ignore
    if (backdrop.style.display === "flex") return;
    // long voyage => c‚Äôest confortable de pouvoir cr√©er en tapant
    openAddModal({ lat: e.latlng.lat, lng: e.latlng.lng });
  });

  btnSave.addEventListener("click", async () => {
    const name = f_name.value.trim();
    const type = f_type.value;
    const bucketTarget = f_bucket.value; // planned | visited
    const note = Math.max(0, Math.min(5, parseInt(f_note.value || "0", 10) || 0));
    const tags = f_tags.value.split(",").map(s => s.trim()).filter(Boolean);
    const comment = f_comment.value;

    if (!name) return alert("Donne un nom au point.");
    if (!modalLatLng) return alert("Choisis un emplacement (position ou tap sur la carte).");

    if (modalMode === "add") {
      const poi = {
        id: slugId(name),
        name,
        type,
        tags,
        lat: modalLatLng.lat,
        lng: modalLatLng.lng,
        info: "", // tu peux laisser vide pour les visit√©s (ou remplir plus tard)
        noteByUser: { "Salima": 0, "R√©my": 0, ...(null) },
        commentByUser: { "Salima": "", "R√©my": "", ...(null) }
      };
      poi.noteByUser[currentUser] = note;
      poi.commentByUser[currentUser] = comment;

      const arr = getBucketArray(bucketTarget);
      arr.unshift(poi);
      setBucketArray(bucketTarget, arr);
      currentPointIdForPhotos = poi.id;
await renderPhotoGrid(poi.id);
alert("Point enregistr√© ‚úÖ Tu peux maintenant ajouter des photos.");

    } else {
      const { bucket, id } = editing;
      const p = findPoi(bucket, id);
      if (!p) return;

      // Si changement de bucket (planned <-> visited)
      const newBucket = bucketTarget;

      // update fields
      p.name = name;
      p.type = type;
      p.tags = tags;
      p.noteByUser = p.noteByUser || {};
      p.commentByUser = p.commentByUser || {};
      p.noteByUser[currentUser] = note;
      p.commentByUser[currentUser] = comment;

      if (bucket !== newBucket) {
        // remove from old
        const oldArr = getBucketArray(bucket).filter(x => x.id !== id);
        setBucketArray(bucket, oldArr);

        // add to new
        const newArr = getBucketArray(newBucket);
        newArr.unshift(p);
        setBucketArray(newBucket, newArr);
      } else {
        setBucketArray(bucket, getBucketArray(bucket)); // resave
      }
    }

    closeBackdrop();
    renderAll();
  });

  btnDelete.addEventListener("click", () => {
    if (modalMode !== "edit") return;
    const ok = confirm("Supprimer ce point ?");
    if (!ok) return;

    const { bucket, id } = editing;
    const arr = getBucketArray(bucket).filter(p => p.id !== id);
    setBucketArray(bucket, arr);

    closeBackdrop();
    renderAll();
  });


let currentPointIdForPhotos = null;
clearPhotoGrid();


function clearPhotoGrid() {
  photoGrid.innerHTML = "";
}

async function renderPhotoGrid(pointId) {
  clearPhotoGrid();
  if (!pointId) return;

  const photos = await getPhotosForPoint(pointId);

  for (const p of photos) {
    const url = URL.createObjectURL(p.blob);

    const wrap = document.createElement("div");
    wrap.className = "thumb";
    wrap.innerHTML = `
      <img src="${url}" alt="photo" />
      <button class="danger" title="Supprimer">‚úñ</button>
    `;

    // clic image = ouvrir en grand (simple)
    wrap.querySelector("img").addEventListener("click", () => {
      window.open(url, "_blank"); // simple preview
    });

    wrap.querySelector("button").addEventListener("click", async () => {
      const ok = confirm("Supprimer cette photo ?");
      if (!ok) return;
      await deletePhoto(p.id);
      renderPhotoGrid(pointId);
    });

    photoGrid.appendChild(wrap);
  }
}

f_photos.addEventListener("change", async () => {
  if (!currentPointIdForPhotos) {
    alert("Enregistre d‚Äôabord le point, puis ajoute les photos.");
    f_photos.value = "";
    return;
  }
  const files = Array.from(f_photos.files || []);
  if (!files.length) return;

  await addPhotosForPoint(currentPointIdForPhotos, files);
  f_photos.value = "";
  await renderPhotoGrid(currentPointIdForPhotos);
});


  // -----------------------------
  // PWA SW
  // -----------------------------
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(() => {});
  }

  // init
  renderAll();
</script>



</body>
</html>
